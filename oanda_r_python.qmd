---
title: "Oanda_Application"
format: 
  html:
    theme: cerulean
    fontsize: 12px
    max-width: 1600px
    #code-fold: False
    code-summary: "Show the code"
    code-fold: show
---

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

## Running Code

When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:

```{r}
library(reticulate)
use_condaenv("~/anaconda3/envs/ML_gpu/bin/python3.9") 
```

```{python}
#| echo: true
#| output: false
import pandas as pd
import tpqoa
api = tpqoa.tpqoa("./oanda.cfg")
api.get_instruments()
api.get_history(instrument = "EUR_USD", start = "2021-03-29", end = "2021-03-31",
                granularity = "M1", price = "M", localize = False)
```

You can add options to executable code like this

```{python}
#| echo: true
#| output: false
#api.stream_data("EUR_USD", stop = 20) 
api.create_order(instrument = "EUR_USD", units = 100000)
```

```{python}
import pandas as pd
import numpy as np
import tpqoa
from datetime import datetime, timedelta
import time
```

```{python}
#| echo: true
#| output: true
days = 5
now = datetime.utcnow() #- timedelta(days = 10)
now = now - timedelta(microseconds = now.microsecond)
past = now - timedelta(days = days)
df = api.get_history(instrument = "EUR_USD", start = "2010-01-01", end = "2010-01-10", granularity = "H1", price = "B",
localize = True).c.dropna().to_frame()
df.rename(columns = {"c":"EUR_USD"}, inplace = True)
df.to_csv('./your_array.csv', header=True, index=True)
df.resample("1min", label = "right").last().dropna().iloc[:-1]
df["SMA_7days"] = df.EUR_USD.rolling(7).mean()
df
```

```{r}
#| echo: true
#| output: false
library(ichimoku)
library(data.table)
library(tidyverse)
library(config)
library(lubridate)
EUR_USD_bid <- oanda("EUR_USD", from = "2010-01-01", to = Sys.Date() - days(1), price = "B", granularity = "D", 
                     apikey = config::get("access_token")) %>% as.data.table()
EUR_USD_bid[, time:=as.Date(time)]
xy <- c("open", "high", "low", "close", "volume")
xy_newnames <- paste0(xy,"_bid")
setnames(EUR_USD_bid,xy,xy_newnames)
xy_SMA_7days <- paste0(xy_newnames, "_SMA_7days")
EUR_USD_bid[, (xy_SMA_7days):=lapply(.SD, frollmean, n = 7, fill=NA), .SDcols=xy_newnames]

setkey(EUR_USD_bid, time)
# python code
# data.price.rolling(7).mean()
EUR_USD_ask <- oanda("EUR_USD", from = "2010-01-01", to = Sys.Date() - days(1), price = "A", granularity = "D", 
                     apikey = config::get("access_token")) %>% as.data.table()
EUR_USD_ask[, time:=as.Date(time)]
xy <- c("open", "high", "low", "close", "volume")
xy_newnames <- paste0(xy,"_ask")
setnames(EUR_USD_ask,xy,xy_newnames)
xy_SMA_7days <- paste0(xy_newnames, "_SMA_7days")
EUR_USD_ask[, (xy_SMA_7days):=lapply(.SD, frollmean, n = 7, fill=NA), .SDcols=xy_newnames]

setkey(EUR_USD_ask, time)
EUR_USD_bid_ask <- merge.data.table(EUR_USD_bid, EUR_USD_ask)
EUR_USD_bid_ask[,c("complete.x", "complete.y")] <- NULL

#EUR_USD_bid_ask[, SellorBuy:=ifelse(close_bid > open_ask, "sell", ifelse())]
```

```{r}
#| echo: true
library(plotly)
library(dygraphs)

# ts_graph <- dygraph(EUR_USD_bid_ask[,c("time","open_bid")]) %>% 
#   dySeries("open_bid", label="open_bid") %>% 
#   dyOptions(fillGraph = FALSE, drawYAxis = TRUE, drawGrid = FALSE, labelsUTC = TRUE) %>% 
#   dyLegend(show = "follow", width = 400) %>% 
#   dyAxis(axisl)
# ts_graph

plot <- ggplot(data = EUR_USD_bid_ask, aes(time)) +
  geom_line(aes(y=open_ask), colour = "blue") + 
  geom_line(aes(y=open_bid), colour = "red")
ggplotly(plot)
```

